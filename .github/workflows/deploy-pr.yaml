name: Deploy Ephemeral Env

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to push the new manifest
      pull-requests: write # Needed to comment on PR

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set Environment Variables
        run: |
          echo "PR_ID=${{ github.event.number }}" >> $GITHUB_ENV
          echo "SHA_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # 1. Build and Push Docker Image
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Setup Pack
        uses: buildpacks/github-actions/setup-pack@v5.9.7

      # 2. Run the build command (This detects your Python app automatically)
      - name: Build and Push with Pack
        run: |
          pack build ${{ secrets.DOCKER_USERNAME }}/demo-app:${{ env.SHA_SHORT }} \
            --builder paketobuildpacks/builder:base \
            --publish

      # 2. The Twist: Generate the Manifest
      - name: Generate and Push Manifest to Infra Repo
        run: |
          # Configure Git
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # 1. Clone the INFRA repository using the PAT
          # Replace 'siddharth-s31' with your username
          git clone https://${{ secrets.GH_PAT }}@github.com/siddharth-s31/infra.git infra-repo
          
          cd infra-repo
          
          # 2. Generate the Manifest
          # We read the template from the 'templates/' folder in the INFRA repo
          mkdir -p environments
          
          sed -e "s/{{PR_ID}}/${{ env.PR_ID }}/g" \
              -e "s/{{IMAGE_TAG}}/${{ env.SHA_SHORT }}/g" \
              templates/template.yaml > environments/pr-${{ env.PR_ID }}.yaml
          
          # 3. Commit and Push
          git add environments/pr-${{ env.PR_ID }}.yaml
          
          # Check if there are changes before committing to avoid errors
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Deploy PR #${{ env.PR_ID }} for App (SHA: ${{ env.SHA_SHORT }})"
            git push origin main
          fi

      # 4. Comment the URL on the PR
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const prId = process.env.PR_ID;
            // REPLACE THIS IP WITH YOUR MACHINE'S IP
            const url = `http://pr-${prId}.172.17.5.38.nip.io`; 
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Ephemeral Environment Deployed!**\n\nAccess your preview here: [${url}](${url})\n\n_Note: It may take a minute for ArgoCD to sync._`
            })
        env:
          PR_ID: ${{ env.PR_ID }}
